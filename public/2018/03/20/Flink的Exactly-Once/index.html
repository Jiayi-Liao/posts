<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Flink的Exactly-Once | W - 廖嘉逸</title>
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?f338e6e48171cfc763820c8cbdff7286";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>

  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url()">
        <div class='av-pic' style="background-image: url()">
        </div>
    </section>
    <section class='menu'>
        <div>W - 廖嘉逸</div>
        
            <div>Liao Jiayi</div>
        
        <ul>
          
        </ul>
    </section>
    <section class="media">
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>Flink的Exactly-Once</h1>
    </header>
    <section>
      <p><a href="https://flink.apache.org/features/2018/03/01/end-to-end-exactly-once-apache-flink.html" target="_blank" rel="noopener">Official Document</a></p>
<h3 id="闲扯"><a href="#闲扯" class="headerlink" title="闲扯"></a>闲扯</h3><p>最近Spark2.3正式发布，流处理不再试Beta版，Spark的Structure Streaming几乎是拥有了Flink的所有功能，生态社区做得好就是不一样，Flink该加把劲了…</p>
<hr>
<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>Exactly-once是一个经常提到的语义，也是程序开发中，需要尽可能做到的一个理想状态。这种语义其实放在分布式程序中有很多种理解，比如读取数据源Exactly-once，Process过程Exactly-once，存储数据Exactly-once，但我们常用的理解方式是End-to-end的语义，也就是说，每一个输入，只会影响一次输出。</p>
<hr>
<h3 id="Exacly-once"><a href="#Exacly-once" class="headerlink" title="Exacly-once"></a>Exacly-once</h3><p>既然是分布式的程序，要达到Exactly-once的语义，在输出那层，就应该只有两种情况，要么一起输出，要么一起不输出。Flink为此就提供了一个<strong>TwoPhaseCommitSinkFunction</strong>的抽象类用来完成这一语义，<a href="https://issues.apache.org/jira/browse/FLINK-7210" target="_blank" rel="noopener">JIRA</a>，<a href="https://github.com/apache/flink/pull/4368" target="_blank" rel="noopener">PR</a>。<br>顾名思义，此类利用了Checkpoint机制提供了两个Phase(步骤)：</p>
<ol>
<li>preCommit()</li>
<li>commit()</li>
</ol>
<h4 id="preCommit-示意图："><a href="#preCommit-示意图：" class="headerlink" title="preCommit()示意图："></a>preCommit()示意图：</h4><p><img src="http://liaojiayi.com/assets/flink-2.png" alt="flink-precommit"><br>这个示意图描述了一个从kafka读取数据，采用WindowFunction做处理，最后再存储到kafka里的数据流。在Checkpoint过程中，首先在Datasource上用barrier把数据流切成两部分并不断传递下去触发snapshot，以保证所有的snapshot都是在相同一部分数据下产生的，最后一个阶段调用Sink函数的Pre-commit()表示，所有的Taskmanager的Sink都可以进行commit()操作了。</p>
<p><strong>注意此时并不能直接commit，因为taskmanager之间彼此并不知道其他的节点是否准备好了commit！</strong></p>
<h4 id="commit-示意图："><a href="#commit-示意图：" class="headerlink" title="commit()示意图："></a>commit()示意图：</h4><p><img src="http://liaojiayi.com/assets/flink-3.png" alt="flink-commit"><br>在checkpoint结束之后，JobManager会通知Listener们调用各自的Callback，<strong>此时Sink对象如果收到了JobManager发出的checkpointCompleted的通知，就知道所有的节点都准备好commit</strong>，然后此时才是真正的commit。</p>
<hr>
<h3 id="用法详解"><a href="#用法详解" class="headerlink" title="用法详解"></a>用法详解</h3><p>简单来说，其实就是两步输出达到Exactly-once的思想，在很多地方都有用到。比如Hive在写表时，先将要写入的文件放入一个临时目录，然后再移入到target directory。</p>
<p><strong>对应到程序里就4个步骤</strong>：</p>
<ul>
<li>beginTransaction - 开始这个事务，比如创建一个临时目录</li>
<li>preCommit - 开始准备最后的commit，比如flush数据到临时目录中</li>
<li>commit - 真正的提交数据，比如将临时目录下的数据移动到最终目录下</li>
<li>abort - 删除临时目录</li>
</ul>
<p>···<br>稍后我会写一个示例放出来<br>···</p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2018-03-19T17:41:00.000Z" itemprop="datePublished">
              2018-03-20
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/flink/">flink</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/exactly-once/">exactly-once</a> }
  </li>


            </div>
          
      </section>
    



</article>

  
</div>

            <footer>
    <div>© 2018 - Liao Jiayi </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>